####################################
########## General Macros ##########
####################################

###############################
##### Start/End Sequences #####
###############################
[gcode_macro START_PRINT]
gcode:
  # Import parameters from slicer
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

  # Run through startup sequence
  G90 ; Use absoulte coordinates
  M140 S{BED_TEMP} ;Start heating bed
  M104 S{EXTRUDER_TEMP} ;Start heating extruder
  G28 ; Home all axes
  M190 S{BED_TEMP} ;Wait for bed to reach temp before proceeding
  # BED_MESH_CALIBRATE ; Auto bed leveling
  G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
  M109 S{EXTRUDER_TEMP} ;Wait for extruder to reach temp before proceeding

  # Set more agressive temp targets for the controllers during print
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=_controller_fan TARGET=55

  # Move to starting position
  G1 X0 Y0 Z2.0 F5000.0 ; Move to start position
  G92 E0 ; Resets extruder

[gcode_macro _START_PRINT_LINE]
gcode:
  G1 X2.0 Y190.0 Z0.3 F1500.0 E15 ; Draw the first line
  G1 X0.4 Y190.0 Z0.3 F5000.0 ; Move to side a little
  G1 X0.4 Y20 Z0.3 F1500.0 E30 ; Draw the second line
  G92 E0 ; Reset Extruder
  G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
  G1 X5 Y20 Z0.3 F5000.0 ; Move over to prevent blob squish

[gcode_macro END_PRINT]
gcode:
  # Move nozzle away from print while retracting
  M83 ; Relative E
  G91 ; Relative XYZ
  G1 X-2 Y-2 Z+5 E-3 F300

  # Present print
  PRESENT_PRINT IGNORE_STATE=true

  # Set ending defaults
  G90 ; Absolute XYZ
  M82 ; Absolute E
  M104 S0 ; turn off temperature
  M140 S0 ; turn off heatbed
  M84 ; Disable steppers
  # Set less agressive temp targets for the controllers during idle
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=_controller_fan TARGET=60

[gcode_macro PRESENT_PRINT]
gcode:
  # Add ignore_state option for END_PRINT
  {% set IGNORE_STATE = params.IGNORE_STATE|default(false) %}
  {% if printer.idle_timeout.state == "Printing" and not IGNORE_STATE %}
    {action_respond_info("This command cannot be used while printing")}
    {action_respond_info("Current Printer state: " + printer.idle_timeout.state)}
  {% elif printer.toolhead.homed_axes != "xyz" %}
    {action_respond_info("Please home XYZ first")}
  {% else %}
    {% set posy = printer.toolhead.axis_maximum.y|float %}
    {% set posx = printer.toolhead.axis_minimum.x|float %}
    G90 ; Use absolute coordinates
    G0 X{posx} Y{posy} F3000
  {% endif %}

#################################
##### G29 Bed Mesh Leveling #####
#################################
[gcode_macro G29]
gcode:
  {% set t = params.T|default(0)|float %}

  {% if printer.idle_timeout.state == "Printing" %}
    {action_respond_info("This command cannot be used while printing")}
  {% elif printer.toolhead.homed_axes != "xyz" %}
    {action_respond_info("Please home XYZ first")}
  {% else %}
    SAVE_GCODE_STATE NAME=G29_state
    G90
    G1 Z10 F240
    {% if t > 30.0 %}
      M190 S{t}
    {% endif %}
    BED_MESH_CALIBRATE
    {% if 'S' in params %}
      M140 S{params.S}
    {% endif %}
    G90
    G1 Z10 F240
    G1 X150 Y155 F6000
    RESTORE_GCODE_STATE NAME=G29_state MOVE=0
  {% endif %}